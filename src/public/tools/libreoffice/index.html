<!DOCTYPE html>
<html lang="en" hidden>
<head>
  <meta charset="UTF-8">
  <title>Librogame link fixer</title>
  <script src="petite-vue-twind.js" defer init></script>

  <script>


    window.downloadFile = (content) => {  
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
      element.setAttribute('download', 'file.fodt');
      element.style.display = 'none';
      document.body.appendChild(element);
      element.click();
      document.body.removeChild(element);
    }


    window.chapterPatterns = {
      '': 'nessuno',
      '<text:bookmark-start\\b[^>]*>(.*?)<text:bookmark-end\\b[^>]*>': 'segnalibri (bookmarks)',
    }

    window.linkPatterns = {
      '': 'nessuno',
      '<text:a\\b[^>]*>(.*?)<\/text:a>': 'link standard',
    }

    window.unwrapFile =  (text, chapterPattern, linkPattern) => {
      if(chapterPattern.trim() !== '') text = text.replace(new RegExp(chapterPattern, "g"), (match, capturedContent) => `{{${capturedContent}}}`)
      if(linkPattern.trim() !== '')    text = text.replace(new RegExp(linkPattern, "g"), (match, capturedContent) => `[[${capturedContent}]]`)
      return text;
    }
      
      


    window.getPurged = (text) => {
      let purgedText = "";
      let purgedTextIndexes = [];
      
      let isBody = false;
      let isInsideBrackets = false;
      let isInsideBinaryData = 0;
      let isHTMLEscape = false;
      
      
      const bodyStart = '<office:body'
      const bodyEnd   = '</office:body>'
      
      const openingSkips = ['<draw:frame', '<office:binary-data']
      const closingSkips = ['</draw:frame>', '</office:binary-data>']
      
      
      let lastChar = '\n'
      const allowedChars = `ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789àèéìòù&;[]{}` // !@#$%^&*()_-+={}[]|\\:;\"'<>,.?/`
        
      for (let i = 0; i < text.length; i++) {
        const currentChar = text[i];
        
        if (currentChar === "<") {
          isInsideBrackets = true;
          if (text.substring(i, i + bodyStart.length) === bodyStart) {
            isBody = true;
          }

          for(let openingSkip of openingSkips){
            if (text.substring(i, i + openingSkip.length) === openingSkip) {
              isInsideBinaryData += 1;
            }
          }

        } else if (currentChar === ">") {
          isInsideBrackets = false;
          if (text.substring(i - bodyEnd.length + 1, i + 1) === bodyEnd) {
            isBody = false
          }

          for(let closingSkip of closingSkips){
            if (text.substring(i - closingSkip.length + 1, i + 1) === closingSkip) {
              isInsideBinaryData -= 1;
            }
          }
        
        } else if (isBody && !isInsideBrackets && isInsideBinaryData === 0) {
          if(currentChar === '&'){
            isHTMLEscape = true;
          } else if(currentChar === ';'){
            isHTMLEscape = false;
          }else {
            if(!isHTMLEscape && ((lastChar !== '\n' && " \t\n".includes(currentChar)) || allowedChars.includes(currentChar))){
              lastChar = currentChar
              purgedText += currentChar;
              purgedTextIndexes.push(i);
            }
          }
        }
      }
      return [purgedText, purgedTextIndexes];
    }

    
    const delimiters = [ '[[', ']]', '{{', '}}' ];



    window.defaultKeywords = `
go to 
going to 
turn to 
turning to 
allez au 
aller au 
vado all
vado al
vai all
vai al 
andare al
andare al 
torno all
torno al 
torna all
torna al 
tornare all
tornare al 
continuo all
continuo al 
continua all
continua al 
continuare all
continuare al 
proseguo all
proseguo al 
prosegui all
prosegui al 
proseguire all
proseguire al 
andando all
andando al 
all
al 
paragrafo 
par 
`

    window.highlightLinks = (text, keywords) => {
      keywords = keywords.trim().split('\n').filter(s => s.length > 0).map(s => s.replaceAll(" ", "\\s+"));

      const findAllMatches = (regex, string) => {
        const matches = Array.from(string.matchAll(regex), match => {
          const { index, 0: fullMatch, ...groups } = match;
          return [
            index + groups[1].length, // groups[1] is the first capturing group, i.e. the keyword
            index + fullMatch.length, // groups[2] is the second capturing group, i.e. the chapter
          ]
        });
        return matches;
      }

      let [purgedText, purgedTextIndexes] = getPurged(text);
      const chapters = findAllMatches(new RegExp(`(${keywords.join('|')})(\\d+)`, 'gi'), purgedText);

      let shift = 0;
      const insertAt = (string, index, insert) => string.slice(0, index) + insert + string.slice(index);
      for(let [start, end] of chapters){
        text = insertAt(text, purgedTextIndexes[start] + shift, delimiters[0]);
        shift += delimiters[0].length;
        text = insertAt(text, purgedTextIndexes[end -1] + shift + 1, delimiters[1]);
        shift += delimiters[1].length;
      }
      return text;
    }

    window.highlightChapters = (text, isolatedChapters) => {
      if(isolatedChapters.trim() === '') return text;
      const [purgedText, purgedTextIndexes] = getPurged(text);

      const titles = Array.from(purgedText.matchAll(new RegExp(isolatedChapters.trim(), "gi")), match => {
        const { index, 0: fullMatch, ...groups } = match;
        return [
          index + groups[1].length, // groups[1] is the first capturing group, i.e. the keyword
          index + groups[1].length + groups[2].length, // groups[2] is the second capturing group, i.e. the chapter
        ]
      });

      let shift = 0;
      const insertAt = (string, index, insert) => string.slice(0, index) + insert + string.slice(index);
      for(let [start, end] of titles){
        text = insertAt(text, purgedTextIndexes[start] + shift, delimiters[2]);
        shift += delimiters[2].length;
        text = insertAt(text, purgedTextIndexes[end -1] + shift + 1, delimiters[3]);
        shift += delimiters[3].length;
      }
      return text
    }


    window.generateFile = (text, singleDelimiters, renameChapters, substituteChapters, substituteLinks) => {
      let single = singleDelimiters;
      const removeTags = (text) => text.replace(/<[^>]+>/g, '');



      let regex = single ? /\{(.*?)\}/g : /\{\{(.*?)\}\}/g;
      let match;
      const capturedGroups = [];
      while ((match = regex.exec(text)) !== null) {
        capturedGroups.push(removeTags(match[1]).trim());
      }
      const reverseGroups = {}
      capturedGroups.forEach((group, i) => {
        reverseGroups[group] = renameChapters ? String(i + 1): group
      })
      const reord = (content) => reverseGroups[removeTags(content).trim()] || content;
      const replacedString = text
        .replace(single ? /\{(.*?)\}/g : /\{\{(.*?)\}\}/g, (match, c) => 
            substituteChapters 
              ? `<text:bookmark-start text:name="${reord(c)}"/>${reord(c)}<text:bookmark-end text:name="${reord(c)}"/>`
              : (single ? '{' : '{{') + reord(c) + (single ? '}' : '}}') 
          )
        .replace(single ? /\[(.*?)\]/g : /\[\[(.*?)\]\]/g, (match, c) => 
            substituteLinks
              ? `<text:a xlink:type="simple" xlink:href="#${reord(c)}" text:style-name="Internet_20_link" text:visited-style-name="Visited_20_Internet_20_Link">${reord(c)}</text:a>`
              : (single ? '[' : '[[') + reord(c) + (single ? ']' : ']]') 
          )
    
      return replacedString;
    }

  </script>
</head>
<body class="p-10 bg-white"
v-scope="{
  singleDelimiters: true,
}">

  <!-- anywhere on the page -->
  <div class="space-y-8 max-w-5xl py-10 md:px-10 mx-auto">
  <div class="text-6xl font-extrabold leading-14 tracking-tight text-gray-900">
    Librogame link fixer
  </div>

  <div class="text-lg leading-7 text-gray-700">
    Inserisci i link nei tuoi librogame scritti con libreoffice.<br>
    Questo strumento ti permette di generare i link in modo automatico, senza doverli scrivere a mano. Inoltre, consente di correggere la numerazione dei paragrafi,
    compattando i numeri in modo da non lasciare buchi.
  </div>

  <div class="text-lg leading-7 text-gray-700">
    <span class="font-bold text-gray-700">Attenzione:</span> questo sito funziona con i file libreoffice non compressi (.fodt). Se il tuo file è compresso (.odt)
    dovrai prima decomprimerlo. Per farlo, clicca salva con nome e scegli il formato fodt, cioé flat openoffice.
  </div>

  <select class="p-3 rounded w-full" id="delimiters" :value="singleDelimiters ? 'single' : 'double'" @change="singleDelimiters = $event.target.value === 'single'">
    <option value="single">Usa parentesi singole per delimitare paragrafi e link, ossia {numero} [numero]</option>
    <option value="double" v-pre>Usa parentesi doppie per delimitare paragrafi e link, ossia {{numero}} [[numero]]</option>
  </select>      
  <div class="pb-8"></div>

  <hr>



  <article class="flex flex-col md:flex-row space-x-5 space-y-8 md:space-y-0 py-4">
    <div class="w-52 flex-none font-bold tracking-tight text-xl text-gray-800">
      1. Individua i link
    </div>
    <div class="text-gray-800 space-y-8">
      <div>
        In questa prima fase, devi "marchiare i link".
      </div>
      <div>
        <span class="font-bold">Manualmente: </span>
        <span v-if="singleDelimiters">inserisci una parentesi quadra [numero] intorno al testo del link. Inserisci una parentesi graffa <span v-pre>{numero}</span> intorno al numero del paragrafo.</span>
        <span v-if="!singleDelimiters">inserisci parentesi quadre doppo [[numero]] intorno al testo del link. Inserisci parentesi graffe doppie <span v-pre>{{numero}}</span> intorno al numero del paragrafo.</span>
      </div>



      <div
       v-scope="{
          count: 0,
          content: '',
          chapterPattern: '<text:bookmark-start\\b[^>]*>(.*?)<text:bookmark-end\\b[^>]*>',
          linkPattern: '<text:a\\b[^>]*>(.*?)<\/text:a>', 
          keywords: defaultKeywords.trim(),       
          findLinks: true,
          isolatedChapters: true,
        }"
       class="space-y-2">
        <div>
          <span class="font-bold">Automaticamente: </span> se hai già un file, puoi caricarlo qui sotto.
        </div>
        <label for="dropzone-file" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 dark:hover:bg-bray-800 dark:bg-gray-700 hover:bg-gray-100 dark:border-gray-600 dark:hover:border-gray-500 dark:hover:bg-gray-600">
          <div class="flex flex-col items-center justify-center pt-5 pb-6">
              <svg v-if="content === ''" aria-hidden="true" class="w-10 h-10 mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
              <p v-if="content === ''" class="mb-2 text-sm text-gray-500 dark:text-gray-400"><span class="font-semibold">Clicca per caricare il file</span> o trascinalo</p>
              <p v-if="content === ''" class="text-xs text-gray-500 dark:text-gray-400">file FODT (libreoffice non compresso)</p>
              <p v-if="content !== ''" class="mb-2 text-sm text-gray-500 dark:text-gray-400">File caricato correttamente!</p>
              <p v-if="content !== ''" class="mb-2 text-sm text-gray-500 dark:text-gray-400">Clicca qui per <span class="font-semibold">caricare un nuovo file</span></p>
          </div>
          <input  id="dropzone-file" type="file" class="hidden" accept=".fodt" @change="
          $event.target.files[0].text().then(text => {
            content = text;
            $event.target.value = '';
          });
          " />
        </label>
        <div v-if="content">
          <div>
            <div class="mb-0.5 mt-4">
              <label for="chapterPattern">Riconosci paragrafi pre-esistenti da:</label>
              <select class="p-1 rounded" id="chapterPattern" :value="chapterPattern in chapterPatterns ? chapterPattern : 'custom'" @change="chapterPattern = $event.target.value">
                <option value="custom">personalizzato</option>
                <option v-for="pattern in Object.entries(chapterPatterns)" :value="pattern[0]">{{pattern[1]}}</option>
              </select>      
            </div>
            <input type="text" class="w-full p-2.5 my-1 text-gray-600 border border-gray-300 text-sm rounded focus:ring-blue-500 focus:border-blue-500" v-model="chapterPattern" />
          </div>
          <div>
            <div class="mb-0.5 mt-4">
              <label for="linkPattern">Riconosci link pre-esistenti da:</label>
              <select class="p-1 rounded" id="linkPattern" :value="linkPattern in linkPatterns ? linkPattern : 'custom'" @change="linkPattern = $event.target.value">
                <option value="custom">personalizzato</option>
                <option v-for="pattern in Object.entries(linkPatterns)" :value="pattern[0]">{{pattern[1]}}</option>
              </select>      
            </div>
            <input type="text" class="w-full p-2.5 my-1 text-gray-600 border border-gray-300 text-sm rounded focus:ring-blue-500 focus:border-blue-500" v-model="linkPattern" />
          </div>
          <div>
            <div class="mb-0.5 mt-4">
              <label for="linkPattern">Riconosci link analizzando il testo:</label>
              <input  type="checkbox"  role="switch" id="flexSwitchChecked" v-model="findLinks"/>
              <textarea class="w-full p-2.5 my-1 min-h-[250px] text-gray-600 border border-gray-300 text-sm rounded focus:ring-blue-500 focus:border-blue-500" v-model="keywords"></textarea>
          </div>
          <div>
            <div class="mb-0.5 mt-4">
              <label for="linkPattern">Riconosci paragrafi che sono isolati:</label>
              <input  type="checkbox"  role="switch" id="flexSwitchChecked" v-model="isolatedChapters"/>
            </div>
          </div>
          <div class="flex flex-row mb-0.5 mt-4 space-x-2 w-full">
            <button class="flex-grow-2 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded block"
            @click="downloadFile(highlightChapters(highlightLinks(unwrapFile(content, chapterPattern, linkPattern),keywords), isolatedChapters ? '(^\\s*|\\n\\s*)(\\d+)\\s*\\n': ''))">
              Download
            </button>
            <button class="bg-gray-400 hover:bg-gray-600 text-white font-bold py-2 px-16 rounded block"  @click="content = ''">
              Annulla
            </button>    
          </div>
        </div>

      </div>

    </div>
  </article>
  <hr>



  <article class="flex flex-col md:flex-row space-x-5 space-y-8 md:space-y-0 py-4">
    <div class="w-52 flex-none font-bold tracking-tight text-xl text-gray-800">
      2. Scrivi il librogame
    </div>
    <div class="text-gray-800 space-y-8">
      Dopo aver marchiato i link nel testo, puoi continuare a scrivere il librogame come preferisci.
      <span v-if="singleDelimiters">Ogni volta che inserisci un nuovo paragrafo, inserisci il numero del paragrafo tra parentesi graffe <span v-pre>{numero}</span>. Ogni volta che inserisci un link, inserisci il testo del link tra parentesi quadre [testo].</span>
      <span v-if="!singleDelimiters">Ogni volta che inserisci un nuovo paragrafo, inserisci il numero del paragrafo tra parentesi graffe doppie <span v-pre>{{numero}}</span>. Ogni volta che inserisci un link, inserisci il testo del link tra parentesi quadre doppie [[testo]].</span>
    </div>
  </article>



  <hr>
  <article class="flex flex-col md:flex-row space-x-5 space-y-8 md:space-y-0 py-4">
    <div class="w-52 flex-none font-bold tracking-tight text-xl text-gray-800">
      3. Genera il file
    </div>
    <div
    v-scope="{
       count: 0,
       content: '',
       renameChapters: true,
       substituteLinks: true,
       substituteChapters: true,
     }"
    class="space-y-2 flex-grow">
      <div>
        Una volta terminato il lavoro di scrittura, carica il file qui sotto per generare il file finale.
      </div>
      <label for="dropzone-file-out" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 dark:hover:bg-bray-800 dark:bg-gray-700 hover:bg-gray-100 dark:border-gray-600 dark:hover:border-gray-500 dark:hover:bg-gray-600">
        <div class="flex flex-col items-center justify-center pt-5 pb-6">
            <svg v-if="content === ''" aria-hidden="true" class="w-10 h-10 mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
            <p v-if="content === ''" class="mb-2 text-sm text-gray-500 dark:text-gray-400"><span class="font-semibold">Clicca per caricare il file</span> o trascinalo</p>
            <p v-if="content === ''" class="text-xs text-gray-500 dark:text-gray-400">file FODT (libreoffice non compresso)</p>
            <p v-if="content !== ''" class="mb-2 text-sm text-gray-500 dark:text-gray-400">File caricato correttamente!</p>
            <p v-if="content !== ''" class="mb-2 text-sm text-gray-500 dark:text-gray-400">Clicca qui per <span class="font-semibold">caricare un nuovo file</span></p>
        </div>
        <input  id="dropzone-file-out" type="file" class="hidden" accept=".fodt" @change="
        $event.target.files[0].text().then(text => {
          console.log('output')
          content = text;
          $event.target.value = '';
        });
        " />
      </label>
      <div v-if="content">
        <div>
          <div class="mb-0.5 mt-4">
            <label for="linkPattern">Rinomina i paragrafi:</label>
            <input  type="checkbox"  role="switch" id="flexSwitchChecked" v-model="renameChapters"/>
          </div>
        </div>
        <div>
          <div class="mb-0.5 mt-4">
            <label for="linkPattern">Sostituisci le parentesi <span v-if="singleDelimiters">{}</span><span v-if="!singleDelimiters"><span v-pre>{{}}</span></span> con segnalibri:</label>
            <input  type="checkbox"  role="switch" id="flexSwitchChecked" v-model="substituteChapters"/>
          </div>
        </div>
        <div>
          <div class="mb-0.5 mt-4">
            <label for="linkPattern">Inserisci link al posto delle parentesi <span v-if="singleDelimiters">[]</span><span v-if="!singleDelimiters">[[]]</span>:</label>
            <input  type="checkbox"  role="switch" id="flexSwitchChecked" v-model="substituteLinks"/>
          </div>
        </div>
        <div class="flex flex-row mb-0.5 mt-4 space-x-2 w-full">
          <button class="flex-grow-2 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded block"
          @click="downloadFile(generateFile(content, singleDelimiters, renameChapters, substituteChapters, substituteLinks))">
            Download
          </button>
          <button class="bg-gray-400 hover:bg-gray-600 text-white font-bold py-2 px-16 rounded block" @click="content = ''">
            Annulla
          </button>    
        </div>
      </div>
    </div>
  </article>

</div>
</body>
</html>